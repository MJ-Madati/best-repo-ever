This is my updated edit for branch 4.